/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var k=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var O=(i,t)=>{for(var e in t)k(i,e,{get:t[e],enumerable:!0})},V=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of L(t))!R.call(i,n)&&n!==e&&k(i,n,{get:()=>t[n],enumerable:!(s=D(t,n))||s.enumerable});return i};var U=i=>V(k({},"__esModule",{value:!0}),i);var $={};O($,{default:()=>d});module.exports=U($);var o=require("obsidian");var y=require("obsidian"),r="28d3e5ae-00e3-4ff6-9443-742f353cf511",_="obsidian://mstodo-auth",w="common",T=["Tasks.ReadWrite","User.Read","offline_access"],a=class{generateCodeVerifier(){let t=new Uint8Array(32);return window.crypto.getRandomValues(t),this.base64UrlEncode(t)}async generateCodeChallenge(t){let s=new TextEncoder().encode(t),n=await window.crypto.subtle.digest("SHA-256",s);return this.base64UrlEncode(new Uint8Array(n))}base64UrlEncode(t){let e="",s=Array.from(t);for(let n of s)e+=String.fromCharCode(n);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async getAuthUrl(t){let e=await this.generateCodeChallenge(t),s=new URLSearchParams({client_id:r,response_type:"code",redirect_uri:_,response_mode:"query",scope:T.join(" "),code_challenge:e,code_challenge_method:"S256"});return`https://login.microsoftonline.com/${w}/oauth2/v2.0/authorize?${s.toString()}`}async exchangeCodeForToken(t,e){let s=new URLSearchParams({client_id:r,scope:T.join(" "),code:t,redirect_uri:_,grant_type:"authorization_code",code_verifier:e});return(await(0,y.requestUrl)({url:`https://login.microsoftonline.com/${w}/oauth2/v2.0/token`,method:"POST",contentType:"application/x-www-form-urlencoded",body:s.toString()})).json}async refreshAccessToken(t){let e=new URLSearchParams({client_id:r,scope:T.join(" "),refresh_token:t,grant_type:"refresh_token"});return(await(0,y.requestUrl)({url:`https://login.microsoftonline.com/${w}/oauth2/v2.0/token`,method:"POST",contentType:"application/x-www-form-urlencoded",body:e.toString()})).json}};var c="ms-todo-view",h="https://graph.microsoft.com/v1.0",b={accessToken:"",refreshToken:"",tokenExpiresAt:0},m=class{constructor(t){this.plugin=t,this.auth=new a}async getValidToken(){let t=Date.now();if(this.plugin.settings.tokenExpiresAt-t<5*60*1e3)if(this.plugin.settings.refreshToken)try{console.log("Token\u5373\u5C06\u8FC7\u671F\uFF0C\u6B63\u5728\u5237\u65B0...");let e=await this.auth.refreshAccessToken(this.plugin.settings.refreshToken);return await this.plugin.saveTokens(e),e.access_token}catch(e){throw new o.Notice("\u767B\u5F55\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55"),e}else throw new Error("\u6CA1\u6709\u767B\u5F55\u4FE1\u606F");return this.plugin.settings.accessToken}async request(t,e="GET",s){let n=await this.getValidToken();return(0,o.requestUrl)({url:t,method:e,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:s?JSON.stringify(s):void 0})}async getTaskLists(){return(await this.request(`${h}/me/todo/lists`)).json.value}async getTasks(t){return(await this.request(`${h}/me/todo/lists/${t}/tasks?$filter=status ne 'completed'`)).json.value}async createTask(t,e){await this.request(`${h}/me/todo/lists/${t}/tasks`,"POST",{title:e})}async completeTask(t,e){await this.request(`${h}/me/todo/lists/${t}/tasks/${e}`,"PATCH",{status:"completed"})}},g=class extends o.ItemView{constructor(t,e){super(t),this.plugin=e}getViewType(){return c}getDisplayText(){return"Microsoft To Do"}getIcon(){return"check-square"}async onOpen(){this.render()}async render(){let t=this.contentEl;if(t.empty(),t.addClass("ms-todo-container"),t.createEl("h4",{text:"My Tasks"}),!this.plugin.settings.accessToken){let s=t.createEl("button",{text:"Sign in Microsoft To Do"});s.onclick=()=>this.plugin.login();return}let e=t.createEl("div",{text:"Loading..."});try{let s=new m(this.plugin),n=await s.getTaskLists();if(!n||n.length===0){e.setText("No tasks found");return}let p=n[0].id;e.remove();let E=t.createEl("div"),v=t.createEl("div",{attr:{style:"display: flex; gap: 10px; margin-bottom: 10px;"}}),P=v.createEl("button",{text:"Refresh"}),A=v.createEl("button",{text:"Sign out"});P.onclick=()=>this.render(),A.onclick=async()=>{await this.plugin.clearData(),this.render()};let S=await s.getTasks(p);S.length===0&&E.createEl("div",{text:"Nothing to do \u{1F389}"}),S.forEach(l=>{let f=E.createEl("div",{cls:"todo-item"}),C=f.createEl("input",{type:"checkbox"});C.onclick=async()=>{f.addClass("completed"),await s.completeTask(p,l.id),setTimeout(()=>this.render(),500)},f.createSpan({text:l.title})});let u=t.createEl("input",{placeholder:"Add a task...",attr:{style:"width: 100%; margin-top: 10px;"}});u.addEventListener("keypress",async l=>{l.key==="Enter"&&u.value.trim()&&(await s.createTask(p,u.value),new o.Notice("Added"),this.render())})}catch(s){e.setText("Error"),t.createEl("div",{text:String(s),attr:{style:"color: red"}}),console.error(s)}}},d=class extends o.Plugin{constructor(){super(...arguments);this.pkceVerifier=""}async onload(){await this.loadSettings(),this.auth=new a,this.registerObsidianProtocolHandler("mstodo-auth",async e=>{await this.handleAuthCallback(e)}),this.registerView(c,e=>new g(e,this)),this.addRibbonIcon("check-square","Microsoft To Do",()=>this.activateView()),this.addSettingTab(new x(this.app,this))}async login(){if(!r.includes("Here")){this.pkceVerifier=this.auth.generateCodeVerifier();let e=await this.auth.getAuthUrl(this.pkceVerifier);window.open(e)}}async handleAuthCallback(e){if(e.error){new o.Notice("Refused");return}if(e.code)try{new o.Notice("Connecting to Microsoft...");let s=await this.auth.exchangeCodeForToken(e.code,this.pkceVerifier);await this.saveTokens(s),new o.Notice("Success\uFF01"),this.refreshView()}catch(s){console.error(s),new o.Notice("\u83B7\u53D6 Token \u5931\u8D25\uFF0C\u8BF7\u770B\u63A7\u5236\u53F0")}}async saveTokens(e){this.settings.accessToken=e.access_token,this.settings.refreshToken=e.refresh_token||this.settings.refreshToken,this.settings.tokenExpiresAt=Date.now()+e.expires_in*1e3,await this.saveSettings()}async clearData(){this.settings=Object.assign({},b),await this.saveSettings()}refreshView(){this.app.workspace.getLeavesOfType(c).forEach(s=>{s.view instanceof g&&s.view.render()})}async loadSettings(){this.settings=Object.assign({},b,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let{workspace:e}=this.app,s=null,n=e.getLeavesOfType(c);n.length>0?s=n[0]:(s=e.getRightLeaf(!1),s&&await s.setViewState({type:c,active:!0})),s&&e.revealLeaf(s)}},x=class extends o.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Microsoft To Do"}),this.plugin.settings.accessToken?(t.createEl("p",{text:"\u2705 Signed in",attr:{style:"color: green"}}),new o.Setting(t).addButton(e=>e.setButtonText("Sign out").onClick(()=>{this.plugin.clearData(),this.display()}))):(t.createEl("p",{text:"\u274C Not signed in"}),new o.Setting(t).addButton(e=>e.setButtonText("Sign in").onClick(()=>this.plugin.login())))}};
