/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var f=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var V=(i,t)=>{for(var e in t)f(i,e,{get:t[e],enumerable:!0})},U=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of L(t))!O.call(i,o)&&o!==e&&f(i,o,{get:()=>t[o],enumerable:!(s=D(t,o))||s.enumerable});return i};var $=i=>U(f({},"__esModule",{value:!0}),i);var N={};V(N,{default:()=>k});module.exports=$(N);var n=require("obsidian");var y=require("obsidian"),c="28d3e5ae-00e3-4ff6-9443-742f353cf511",_="obsidian://mstodo-auth",T="common",m=["Tasks.ReadWrite","User.Read","offline_access"],l=class{generateCodeVerifier(){let t=new Uint8Array(32);return window.crypto.getRandomValues(t),this.base64UrlEncode(t)}async generateCodeChallenge(t){let s=new TextEncoder().encode(t),o=await window.crypto.subtle.digest("SHA-256",s);return this.base64UrlEncode(new Uint8Array(o))}base64UrlEncode(t){let e="",s=Array.from(t);for(let o of s)e+=String.fromCharCode(o);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async getAuthUrl(t){let e=await this.generateCodeChallenge(t),s=new URLSearchParams({client_id:c,response_type:"code",redirect_uri:_,response_mode:"query",scope:m.join(" "),code_challenge:e,code_challenge_method:"S256"});return`https://login.microsoftonline.com/${T}/oauth2/v2.0/authorize?${s.toString()}`}async exchangeCodeForToken(t,e){let s=new URLSearchParams({client_id:c,scope:m.join(" "),code:t,redirect_uri:_,grant_type:"authorization_code",code_verifier:e});return(await(0,y.requestUrl)({url:`https://login.microsoftonline.com/${T}/oauth2/v2.0/token`,method:"POST",contentType:"application/x-www-form-urlencoded",body:s.toString()})).json}async refreshAccessToken(t){let e=new URLSearchParams({client_id:c,scope:m.join(" "),refresh_token:t,grant_type:"refresh_token"});return(await(0,y.requestUrl)({url:`https://login.microsoftonline.com/${T}/oauth2/v2.0/token`,method:"POST",contentType:"application/x-www-form-urlencoded",body:e.toString()})).json}};var d="ms-todo-view",u="https://graph.microsoft.com/v1.0",P={accessToken:"",refreshToken:"",tokenExpiresAt:0},v=class{constructor(t){this.plugin=t,this.auth=new l}async getValidToken(){let t=Date.now();if(this.plugin.settings.tokenExpiresAt-t<5*60*1e3)if(this.plugin.settings.refreshToken)try{console.warn("Token\u5373\u5C06\u8FC7\u671F\uFF0C\u6B63\u5728\u5237\u65B0...");let e=await this.auth.refreshAccessToken(this.plugin.settings.refreshToken);return await this.plugin.saveTokens(e),e.access_token}catch(e){throw new n.Notice("\u767B\u5F55\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55"),e}else throw new Error("\u6CA1\u6709\u767B\u5F55\u4FE1\u606F");return this.plugin.settings.accessToken}async request(t,e="GET",s){let o=await this.getValidToken();return(0,n.requestUrl)({url:t,method:e,headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:s?JSON.stringify(s):void 0})}async getTaskLists(){return(await this.request(`${u}/me/todo/lists`)).json.value}async getTasks(t){return(await this.request(`${u}/me/todo/lists/${t}/tasks?$filter=status ne 'completed'`)).json.value}async createTask(t,e){await this.request(`${u}/me/todo/lists/${t}/tasks`,"POST",{title:e})}async completeTask(t,e){await this.request(`${u}/me/todo/lists/${t}/tasks/${e}`,"PATCH",{status:"completed"})}},p=class extends n.ItemView{constructor(t,e){super(t),this.plugin=e}getViewType(){return d}getDisplayText(){return"Microsoft to do"}getIcon(){return"check-square"}async onOpen(){await this.render()}async render(){let t=this.contentEl;if(t.empty(),t.addClass("ms-todo-container"),t.createEl("h4",{text:"My tasks"}),!this.plugin.settings.accessToken){let s=t.createEl("button",{text:"Sign in microsoft to do"});s.onclick=()=>this.plugin.login();return}let e=t.createEl("div",{text:"Loading..."});try{let s=new v(this.plugin),o=await s.getTaskLists();if(!o||o.length===0){e.setText("No tasks found");return}let w=o[0].id;e.remove();let x=t.createEl("div"),S=t.createEl("div",{attr:{style:"display: flex; gap: 10px; margin-bottom: 10px;"}}),A=S.createEl("button",{text:"Refresh"}),C=S.createEl("button",{text:"Sign out"});A.onclick=()=>this.render(),C.onclick=async()=>{await this.plugin.clearData(),this.render()};let b=await s.getTasks(w);b.length===0&&x.createEl("div",{text:"Nothing to do \u{1F389}"}),b.forEach(h=>{let r=x.createEl("div",{cls:"todo-item"}),g=r.createEl("input",{type:"checkbox"});g.onclick=()=>{(async()=>{try{r.addClass("completed"),await s.completeTask(w,h.id),setTimeout(()=>{this.render()},500)}catch(R){r.removeClass("completed"),g.checked=!1,new n.Notice("Failed to complete task"),console.error(R)}})()},r.createSpan({text:h.title})});let a=t.createEl("input",{placeholder:"Add a task...",attr:{style:"width: 100%; margin-top: 10px;"}});a.addEventListener("keypress",h=>{if(h.key==="Enter"&&a.value.trim()){let r=a.value.trim();a.value="",(async()=>{try{await s.createTask(w,r),new n.Notice("Task added"),await this.render()}catch(g){new n.Notice("Failed to create task"),console.error(g),a.value=r}})()}})}catch(s){e.setText("Error"),t.createEl("div",{text:String(s),attr:{style:"color: red"}}),console.error(s)}}},k=class extends n.Plugin{constructor(){super(...arguments);this.pkceVerifier=""}async onload(){await this.loadSettings(),this.auth=new l,this.registerObsidianProtocolHandler("mstodo-auth",async e=>{await this.handleAuthCallback(e)}),this.registerView(d,e=>new p(e,this)),this.addRibbonIcon("check-square","Microsoft to do",()=>this.activateView()),this.addSettingTab(new E(this.app,this))}async login(){if(!c.includes("Here")){this.pkceVerifier=this.auth.generateCodeVerifier();let e=await this.auth.getAuthUrl(this.pkceVerifier);window.open(e)}}async handleAuthCallback(e){if(e.error){new n.Notice("Refused");return}if(e.code)try{new n.Notice("Connecting to microsoft...");let s=await this.auth.exchangeCodeForToken(e.code,this.pkceVerifier);await this.saveTokens(s),new n.Notice("Success\uFF01"),this.refreshView()}catch(s){console.error(s),new n.Notice("\u83B7\u53D6 token \u5931\u8D25\uFF0C\u8BF7\u770B\u63A7\u5236\u53F0")}}async saveTokens(e){this.settings.accessToken=e.access_token,this.settings.refreshToken=e.refresh_token||this.settings.refreshToken,this.settings.tokenExpiresAt=Date.now()+e.expires_in*1e3,await this.saveSettings()}async clearData(){this.settings=Object.assign({},P),await this.saveSettings()}refreshView(){this.app.workspace.getLeavesOfType(d).forEach(s=>{s.view instanceof p&&s.view.render()})}async loadSettings(){this.settings=Object.assign({},P,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let{workspace:e}=this.app,s=null,o=e.getLeavesOfType(d);o.length>0?s=o[0]:(s=e.getRightLeaf(!1),s&&await s.setViewState({type:d,active:!0})),s&&e.revealLeaf(s)}},E=class extends n.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new n.Setting(t).setName("Microsoft to do").setHeading(),this.plugin.settings.accessToken?new n.Setting(t).setName("Account status").setDesc("\u2705 signed in").addButton(e=>e.setButtonText("Sign out").setWarning().onClick(async()=>{await this.plugin.clearData(),this.display()})):new n.Setting(t).setName("Account status").setDesc("\u274C not signed in").addButton(e=>e.setButtonText("Sign in").setCta().onClick(()=>{this.plugin.login()}))}};
